<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCM Chill Spots - B·∫£n ƒê·ªì Nh√≥m</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* B·∫£ng ƒëi·ªÅu khi·ªÉn */
        .info-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 220px;
        }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #d81b60; text-align: center; }
        .stats { background: #fce4ec; padding: 8px; border-radius: 8px; text-align: center; margin-bottom: 10px; font-weight: bold; color: #ad1457; }
        
        button { 
            width: 100%; padding: 10px; border: none; border-radius: 6px; 
            cursor: pointer; font-weight: bold; margin-bottom: 5px; transition: 0.3s; 
        }
        .btn-refresh { background: #1e88e5; color: white; }
        .btn-refresh:hover { background: #1565c0; }
        .btn-heat { background: #fb8c00; color: white; }
        
        /* Icon tr√™n b·∫£n ƒë·ªì */
        .custom-icon { 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        .bg-cafe { background-color: #6d4c41; color: white; }
        .bg-food { background-color: #f4511e; color: white; }
        
        /* Form nh·∫≠p li·ªáu Popup */
        .popup-form select, .popup-form input { 
            width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; 
            border-radius: 4px; box-sizing: border-box; 
        }
        .popup-form button { 
            background: #43a047; color: white; width: 100%; border: none; 
            padding: 10px; margin-top: 5px; border-radius: 4px; cursor: pointer; 
        }
    </style>
</head>
<body>

<div class="info-panel">
    <h2>HCM Chill Spots üçï</h2>
    <div class="stats">üìç <span id="counter">0</span> ƒê·ªãa ƒëi·ªÉm</div>
    <button class="btn-refresh" onclick="loadData()"><i class="fa-solid fa-sync"></i> L√†m m·ªõi b·∫£n ƒë·ªì</button>
    <button class="btn-heat" onclick="toggleHeatmap()"><i class="fa-solid fa-fire"></i> Xem v√πng "Hot"</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
    // Link Apps Script C·ª¶A B·∫†N (ƒê√£ ki·ªÉm tra ho·∫°t ƒë·ªông t·ªët)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNW22SGxreIZB4XoyTgsU5THAte88d8kWmX9EEfVPsK2oFaKgJ0sqPzqmIPOvKs5K20A/exec";
    
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    var map = L.map('map').setView([10.7769, 106.7009], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    var markersLayer = L.layerGroup().addTo(map); // Layer ch·ª©a c√°c ƒëi·ªÉm
    var heatLayer = null;
    var allData = [];

    // H√†m l·∫•y Icon chu·∫©n
    function getIcon(category) {
        let iconHtml = category === 'food' ? '<i class="fa-solid fa-utensils"></i>' : '<i class="fa-solid fa-mug-hot"></i>';
        let colorClass = category === 'food' ? 'bg-food' : 'bg-cafe';
        return L.divIcon({
            html: iconHtml,
            className: `custom-icon ${colorClass}`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
    }

    // --- H√ÄM 1: T·∫£i d·ªØ li·ªáu t·ª´ Google Sheets ---
    function loadData() {
        document.getElementById('counter').innerText = "...";
        
        fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                markersLayer.clearLayers(); // X√≥a ƒëi·ªÉm c≈©
                allData = data; // L∆∞u d·ªØ li·ªáu ƒë·ªÉ d√πng cho heatmap
                let count = 0;

                data.forEach((row, index) => {
                    if (index === 0) return; // B·ªè qua d√≤ng ti√™u ƒë·ªÅ

                    // L·∫•y d·ªØ li·ªáu t·ª´ m·∫£ng
                    var lat = row[0];
                    var lng = row[1];
                    var note = row[2];
                    var category = row[3];

                    if (lat && lng) {
                        var marker = L.marker([lat, lng], {icon: getIcon(category)})
                            .bindPopup(`<b>${note}</b><br><small>${category}</small>`);
                        
                        markersLayer.addLayer(marker);
                        count++;
                    }
                });

                document.getElementById('counter').innerText = count;
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. H√£y nh·∫•n n√∫t "L√†m m·ªõi b·∫£n ƒë·ªì" l·∫°i nh√©!');
            });
    }

    // --- H√ÄM 2: Click b·∫£n ƒë·ªì ƒë·ªÉ th√™m qu√°n m·ªõi ---
    map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        var popupContent = `
            <div class="popup-form">
                <h3>Th√™m ƒë·ªãa ƒëi·ªÉm m·ªõi</h3>
                <input type="text" id="noteInput" placeholder="T√™n qu√°n / Ghi ch√∫">
                <select id="catInput">
                    <option value="cafe">‚òï C√† ph√™</option>
                    <option value="food">üç¥ ƒÇn u·ªëng</option>
                </select>
                <button id="saveBtn">L∆∞u l√™n b·∫£n ƒë·ªì chung</button>
            </div>
        `;

        var popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map);

        // X·ª≠ l√Ω khi nh·∫•n n√∫t L∆∞u trong popup
        setTimeout(() => {
            document.getElementById('saveBtn').onclick = function() {
                var note = document.getElementById('noteInput').value;
                var category = document.getElementById('catInput').value;
                
                if(!note) { alert("Vui l√≤ng nh·∫≠p t√™n qu√°n!"); return; }

                this.innerText = "ƒêang l∆∞u...";
                this.disabled = true;

                // G·ª≠i d·ªØ li·ªáu v·ªÅ Google Sheets (S·ª≠ d·ª•ng method POST)
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lat, lng: lng, note: note, category: category })
                }).then(() => {
                    map.closePopup();
                    alert("ƒê√£ l∆∞u th√†nh c√¥ng! Nh·∫•n 'L√†m m·ªõi' ƒë·ªÉ th·∫•y ƒëi·ªÉm.");
                    loadData(); // T·∫£i l·∫°i b·∫£n ƒë·ªì
                }).catch(err => {
                    alert("L·ªói khi l∆∞u!");
                    console.error(err);
                });
            };
        }, 100);
    });

    // --- H√ÄM 3: B·∫≠t/t·∫Øt Heatmap ---
    function toggleHeatmap() {
        if (heatLayer) { 
            map.removeLayer(heatLayer); 
            heatLayer = null; 
        } else { 
            // L·∫•y d·ªØ li·ªáu t·ªça ƒë·ªô ƒë·ªÉ v·∫Ω heatmap
            let heatData = [];
            allData.forEach((row, index) => {
                if(index > 0 && row[0] && row[1]) {
                    heatData.push([row[0], row[1], 0.5]); 
                }
            });
            
            if(heatData.length > 0) {
                heatLayer = L.heatLayer(heatData, {radius: 25, blur: 15}).addTo(map); 
            } else {
                alert("Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ hi·ªán v√πng Hot!");
            }
        }
    }

    // Ch·∫°y ngay khi m·ªü web
    loadData();
</script>

</body>
</html>
